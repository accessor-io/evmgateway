# @ensdomains/evm-verifier
A Solidity library that verifies state proofs generated by an [evm-gateway](https://github.com/ensdomains/evmgateway/tree/main/evm-gateway) instance. This library implements all the functionality required make CCIP-Read calls to an EVM gateway and verify the responses, except for verifying the root of the proof. This library is intended to be used by libraries for specific EVM-compatible chains that implement the missing  functionality.

---

## Contract 'EVMFetchTarget'

The `EVMFetchTarget` contract serves as a callback handler for CCIP-Read responses related to `getStorageSlots` requests. When inheriting and implementing this contract, pay attention to security considerations, especially around dynamic function calls and data decoding. The use of custom errors and Solidity assembly highlights the advanced nature of this contract. 

#### EVMFetchTarget.sol Contract Structure:

- **Inheritance**: Inherits from Solidity's `abstract` keyword, meaning it cannot be instantiated on its own but must be inherited by another contract.
- **Libraries**: Uses the `Address` contract from OpenZeppelin for address utility functions.
- **Error**: Defines a custom error `ResponseLengthMismatch` with parameters `actual` and `expected` for handling length mismatches in responses.
- **Function**: `getStorageSlotsCallback(bytes calldata response, bytes calldata extradata) external`
    - **Parameters**: 
        - `response` (bytes calldata): The response from the CCIP-Read.
        - `extradata` (bytes calldata): Additional data associated with the request.
    - **Operations**:
        - Decodes the `response` to get the `proof`.
        - Decodes the `extradata` to extract parameters like `verifier`, `addr`, `commands`, `constants`, `callback`, and `callbackData`.
        - Calls `getStorageValues` on the `verifier` with decoded parameters and the `proof`.
        - Checks if the length of returned values matches the length of commands, reverts if not.
        - Dynamically calls the `callback` function with `values` and `callbackData`.
        - Handles the return value using Solidity assembly.

#### Considerations and Best Practices:

- **Abstract Nature**: Ensure that the contract inheriting `EVMFetchTarget` implements all necessary logic to work with `EVMFetcher`.
- **Error Handling**: The custom error `ResponseLengthMismatch` is for clear and gas-efficient error reporting.
- **Dynamic Function Calls**: The contract uses dynamic function calls with `functionCall`. Ensure that the `callback` function is secure and does not introduce vulnerabilities.
- **Data Decoding**: The decoding of `response` and `extradata` must be structured correctly to prevent decoding errors.
- **Security**: Review all external calls and dynamic function invocations for potential reentrancy attacks or other security vulnerabilities.

---

## Contract `EVMFetcher` 

The `EVMFetcher` facilitates requesting storage data proofs from contracts. It provides a structured way to create and execute fetch requests for storage slots in smart contracts, supporting both static and dynamic values, as well as slot numbers derived from other retrieved values. When integrating this contract, ensure that the security and error handling aspects are thoroughly reviewed and tested in the context of the specific use case.


#### EVMFetcher.sol Contract Structure:

- **Inheritance**: Meant to be used via the `using` directive in other contracts.
- **Constants**: Defines constants for flags and operation codes.
- **Structs**: Defines a struct `EVMFetchRequest` to encapsulate request data.
- **Functions**: Provides a set of functions for constructing and executing fetch requests.

#### Key Functions

- **`newFetchRequest`**: Initializes a new fetch request with a given verifier and target address.
- **`getStatic` and `getDynamic`**: Start describing new fetch requests for static or dynamic storage slots.
- **`element`**: Overloaded for various types, adds an element to the current path for slot calculation.
- **`ref`**: Adds a reference to a previous fetch in the current path.
- **`fetch`**: Initiates the fetch request, using CCIP-Read to get storage slots. It terminates execution and expects a callback with results.
- **`_addConstant`**: Private function to add a constant to the request.
- **`_addOperation`**: Private function to add an operation to the command in the request.

#### Considerations:

- **Usage**:  It should be included in other contracts using the `using EVMFetcher for EVMFetchRequest;` directive.
- **Error Handling**: The custom errors provide clear feedback on failure scenarios, which is a good practice.
- **Operation Limits**: The constants `MAX_COMMANDS` and `MAX_CONSTANTS` impose limits on the number of commands and constants. Ensure these limits are suitable for your use case.
- **Dynamic Storage Handling**: The contract supports dynamic storage slot calculations, which can be complex. Ensure the paths are correctly constructed.

---    

## Contract `EVMProofHelper` 

The `EVMProofHelper` is designed to assist with the verification of storage proofs against a given state root. It includes functions to retrieve storage roots, validate individual storage slots, and execute predefined operations for constructing storage paths. 


#### Contract Structure:

- **Inheritance**: Intended to be used with the `using` directive in other contracts.
- **Imports**: Utilizes other libraries such as `RLPReader`, `Bytes`, and `SecureMerkleTrie`.
- **Structs**: Defines `StateProof` struct to encapsulate proof data.
- **Constants**: Defines operation codes and flags.
- **Functions**: Provides a set of functions for working with storage proofs.

#### Key Functions and Operations:

- **`getStorageRoot`**: Retrieves the storage root from a provided state root and witness for a specified target address.
- **`getSingleStorageProof`**: Validates whether a given storage slot is part of the specified storage root.
- **`getFixedValue`**: Retrieves a fixed value from a storage slot.
- **`executeOperation`**: Executes a predefined operation based on constants and values.
- **`computeFirstSlot`**: Computes the first slot for a given command, determining if it is dynamic or static.
- **`getDynamicValue`**: Retrieves dynamic values from storage slots.
- **`getStorageValues`**: Public function that retrieves storage values based on given commands and constants.

#### Considerations and Best Practices:

- **Usage**: Ensure it is properly included and used in contracts that require storage proof verification.
- **Data Types and Encoding**: The contract deals extensively with bytes and RLP encoding. Ensure that the data is correctly encoded and decoded.
- **Storage Proof Verification**: The contract is crucial for verifying storage proofs, particularly in cross-chain or layer-2 scenarios.
- **Security**: Given its critical role in verifying storage data, ensure that all security aspects are thoroughly reviewed and tested.

---

## Contract `IEVMVerifier` 

The `IEVMVerifier` is an interface in Solidity, defining the structure and expected functionalities of an EVM Verifier. Its primary purpose is to facilitate the verification of storage values and provide access to gateway URLs. This interface is to be implemented by contracts requiring the verification of storage proofs, particularly in cross-chain or layer-2 contexts.

#### Contract Structure:

- **Pragma Directive**: Specifies the Solidity version as `^0.8.17`.
- **Interface Declaration**: The `IEVMVerifier` is declared as an interface, meaning it will only contain function declarations without implementation.

#### Key Functions:

 **`gatewayURLs`**:
   - **Visibility**: `external view`
   - **Returns**: `string[] memory`
   - **Description**: This function is expected to return an array of strings, representing URLs. These URLs might be related to gateways or endpoints necessary for the verification process or other related tasks.

 **`getStorageValues`**:
   - **Parameters**:
     - `address target`: The target address for which storage values are to be retrieved.
     - `bytes32[] memory commands`: An array of commands, possibly indicating operations or instructions for retrieving storage values.
     - `bytes[] memory constants`: An array of constants, potentially used in conjunction with commands for computation or retrieval purposes.
     - `bytes memory proof`: A bytes representation of the proof required for verification.
   - **Visibility**: `external view`
   - **Returns**: `bytes[] memory values`
   - **Description**: This function is designed to retrieve storage values for a given target address based on specified commands, constants, and provided proof. It plays a crucial role in the verification process, ensuring the integrity and validity of storage data.

#### Considerations

- **Implementation**: As an interface, it's crucial to provide concrete implementations of these functions in contracts that inherit from `IEVMVerifier`.
- **Security**: The implementation should rigorously validate inputs and handle proofs securely.
- **Use Case**: This interface is to be used in scenarios involving storage proof verification, cross-chain communication, or layer-2 solutions.
- **Data Handling**: Proper handling and interpretation of commands, constants, and proofs are vital for the correct functioning of the implementing contract.


---


## `MerkleTrie` Contract

The `MerkleTrie` contract is designed to verify standard Ethereum Merkle-Patricia trie inclusion proofs. This contract plays a crucial role in verifying the existence and validity of data within the trie, which is a fundamental data structure used for storing the state in Ethereum.


#### Contract Structure:

- **Pragma Directive**: Specifies the Solidity version as `^0.8.0`.
- **Library Declaration**: `MerkleTrie` is declared as a library, meaning it provides reusable functions for other contracts but does not hold state.
- **Dependencies**: Imports `Bytes` and `RLPReader` from `@eth-optimism/contracts-bedrock`.

#### Key Components:

 **Constants**:
   - `TREE_RADIX`: Represents the number of elements per branch node in the trie, set to 16 (hexary trie).
   - `BRANCH_NODE_LENGTH`: Number of elements in a branch node, including one value element.
   - `LEAF_OR_EXTENSION_NODE_LENGTH`: Number of elements in leaf or extension nodes.
   - Prefix constants for different node types.
     
**Structs**:
   - `TrieNode`: Represents a node in the trie with encoded and decoded forms.

 **Core Functions**:
   - **`verifyInclusionProof`**: Verifies the inclusion of a key/value pair in the trie using a provided proof and known root.
   - **`get`**: Retrieves the value associated with a given key using the proof and known root.
   - **`_walkNodePath`**: Internal function that walks through a proof using a provided key.
   - **`_parseProof`**: Internal function that parses an array of proof elements.
   - **`_getNodeID`**: Internal function that picks out the ID for a node.
   - **`_getNodePath`**: Internal function that gets the path for a leaf or extension node.
   - **`_getNodeValue`**: Internal function that gets the value for a node.
   - **`_getSharedNibbleLength`**: Internal utility function that determines the number of nibbles shared between two nibble arrays.


---

## `SecureMerkleTrie` Contract

`SecureMerkleTrie` is a thin wrapper around the `MerkleTrie` contract, specifically designed for Ethereum's state trie which hashes input keys before storing them. This contract introduces an additional layer of security by hashing the keys, aligning with the standard practice in Ethereum.

#### Key Components:

 **Functions**:
   - **`verifyInclusionProof`**: Verifies a proof that a given key/value pair is present in the Merkle trie, with the key being hashed before verification.
   - **`get`**: Retrieves the value associated with a given key, with the key being hashed before retrieval.
   - **`_getSecureKey`**: Internal function to compute the hashed version of the input key.


