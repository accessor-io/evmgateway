# @ensdomains/evm-verifier
A Solidity library that verifies state proofs generated by an [evm-gateway](https://github.com/ensdomains/evmgateway/tree/main/evm-gateway) instance. This library implements all the functionality required make CCIP-Read calls to an EVM gateway and verify the responses, except for verifying the root of the proof. This library is intended to be used by libraries for specific EVM-compatible chains that implement the missing  functionality.

For a detailed readme and usage instructions, see the [monorepo readme](https://github.com/ensdomains/evmgateway/tree/main).

The `EVMFetchTarget` contract is an abstract contract that provides a callback implementation for users of `EVMFetcher`. It's designed to work with CCIP-Read responses for `getStorageSlots` requests.

---

#### EVMFetchTarget.sol Contract Structure:

- **Inheritance**: Inherits from Solidity's `abstract` keyword, meaning it cannot be instantiated on its own but must be inherited by another contract.

- **Libraries**: Uses the `Address` library from OpenZeppelin for address utility functions.

- **Error**: Defines a custom error `ResponseLengthMismatch` with parameters `actual` and `expected` for handling length mismatches in responses.

- **Function**: `getStorageSlotsCallback(bytes calldata response, bytes calldata extradata) external`
    - **Parameters**: 
        - `response` (bytes calldata): The response from the CCIP-Read.
        - `extradata` (bytes calldata): Additional data associated with the request.
    - **Operations**:
        - Decodes the `response` to get the `proof`.
        - Decodes the `extradata` to extract parameters like `verifier`, `addr`, `commands`, `constants`, `callback`, and `callbackData`.
        - Calls `getStorageValues` on the `verifier` with decoded parameters and the `proof`.
        - Checks if the length of returned values matches the length of commands, reverts if not.
        - Dynamically calls the `callback` function with `values` and `callbackData`.
        - Handles the return value using Solidity assembly.

---

#### Considerations and Best Practices:

- **Abstract Nature**: Ensure that the contract inheriting `EVMFetchTarget` implements all necessary logic to work with `EVMFetcher`.

- **Error Handling**: The custom error `ResponseLengthMismatch` is a good practice for clear and gas-efficient error reporting.

- **Solidity Assembly**: The use of Solidity assembly for handling the return value should be approached with caution due to its complexity and potential security implications.

- **Dynamic Function Calls**: The contract uses dynamic function calls with `functionCall`. Ensure that the `callback` function is secure and does not introduce vulnerabilities.

- **Data Decoding**: The decoding of `response` and `extradata` is crucial. Ensure that the data is structured correctly to prevent decoding errors.

- **Security**: Review all external calls and dynamic function invocations for potential reentrancy attacks or other security vulnerabilities.

- **Gas Optimization**: Check the gas usage of the contract, especially considering the dynamic function calls and assembly code.

The `EVMFetchTarget` contract serves as a callback handler for CCIP-Read responses related to `getStorageSlots` requests. When inheriting and implementing this contract, pay attention to security considerations, especially around dynamic function calls and data decoding. The use of custom errors and Solidity assembly highlights the advanced nature of this contract. 
